/*
* This pipeline script was created manually based on scripts created by jenkins-build-creator.
*
*/
@Library('integration-pipeline-library@ro-common-stages')
import com.synopsys.integration.Constants
import com.synopsys.integration.pipeline.scm.GitStage

properties(
    [
        limitBuildsToKeep(),
        disableConcurrentBuilds(), 
        parameters(
            [
                releaseCheckbox(),
                releaseCommitMessage(),
                selectBranch('origin/main')
            ]
        )
    ]
)

pipeline {
    agent {
        label 'integrations'
    }
    stages {
        checkoutAndExportGitEnvironment('https://github.com/synopsys-sig/coverity-report-output-v7-json.git'){}
        stage('Release') {
            when {
                allOf {
                    expression { return params.RUN_RELEASE }
                    not { branch 'main' }
                }
            }
            steps {
                withCredentials([usernamePassword(credentialsId: GitStage.DEFAULT_CREDENTIALS_ID, passwordVariable: 'GIT_PASSWORD', usernameVariable: 'GIT_USERNAME')]) {
                    sh "git branch -u origin/${env.GIT_LOCAL_BRANCH}"
                    sh "git remote set-url origin ${GIT_URL.replace('https://', "https://${GIT_USERNAME}:${GIT_PASSWORD}@")}"
                }
                sh 'npm ci'
                sh "npm version ${env.GIT_LOCAL_BRANCH}"
                archiveArtifacts 'dist/*.js*'
            }
        }
    }
    post {
        failure {
            echo 'Sending out Build Failure email'
            emailext(
                body: '$DEFAULT_CONTENT', 
                subject: '$DEFAULT_SUBJECT', 
                to: Constants.CENTRAL_INTEGRATIONS_TEAM_EMAIL
            )
        } 
        fixed {
            echo 'Sending out Build Fixed email'
            emailext(
                body: "${env.JOB_NAME} - Build #${env.BUILD_NUMBER} - Fixed!\nCheck console output at ${env.BUILD_URL} to view the results.", 
                subject: "${env.JOB_NAME} - Build #${env.BUILD_NUMBER} - Fixed!", 
                to: Constants.CENTRAL_INTEGRATIONS_TEAM_EMAIL
            )
        }
    }
}
